<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transcript Search | BarberX Legal Tech</title>
    <link rel="stylesheet" href="/assets/css/legal-tech-platform.css" />
    <style>
      body {
        background: var(--bg-color);
        margin: 0;
        padding: 2rem;
      }

      .tool-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .tool-header {
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border-left: 4px solid var(--accent-blue);
      }

      .search-box {
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
      }

      .search-input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .search-input {
        flex: 1;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
      }

      .search-filters {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .filter-tag {
        padding: 0.5rem 1rem;
        background: var(--primary-navy-10);
        border-radius: 20px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-tag button {
        background: none;
        border: none;
        color: var(--accent-blue);
        cursor: pointer;
        font-weight: 700;
      }

      .results-container {
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 12px;
      }

      .result-item {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
      }

      .result-item:last-child {
        border-bottom: none;
      }

      .result-item:hover {
        background: var(--bg-color);
      }

      .result-meta {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .result-text {
        margin: 0.5rem 0;
        line-height: 1.6;
      }

      .highlight {
        background: #fef3c7;
        padding: 0.125rem 0.25rem;
        border-radius: 3px;
        font-weight: 600;
      }

      .timestamp {
        color: var(--accent-blue);
        font-weight: 600;
      }

      .speaker-badge {
        background: var(--accent-blue);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
      }

      .stats-bar {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .stat-item {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .stat-item strong {
        color: var(--accent-blue);
        font-size: 1.125rem;
      }
    </style>
  </head>
  <body>
    <div class="tool-container">
      <div class="tool-header">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1 style="margin: 0 0 0.5rem 0">üìù Transcript Search</h1>
            <p style="margin: 0; color: var(--text-secondary)">
              Search across all your BWC transcripts with advanced filtering
            </p>
          </div>
          <a href="/dashboard" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
      </div>

      <div class="search-box">
        <h3 style="margin-bottom: 1rem">Search Transcripts</h3>

        <div class="search-input-group">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Search for keywords, phrases, names, dates..."
            autocomplete="off"
          />
          <button
            class="btn btn-primary"
            onclick="performSearch()"
            style="min-width: 120px"
          >
            üîç Search
          </button>
        </div>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
          "
        >
          <div>
            <label
              style="display: block; margin-bottom: 0.5rem; font-weight: 600"
              >Case Number</label
            >
            <input
              type="text"
              id="caseFilter"
              placeholder="All cases"
              style="
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            />
          </div>
          <div>
            <label
              style="display: block; margin-bottom: 0.5rem; font-weight: 600"
              >Speaker</label
            >
            <select
              id="speakerFilter"
              style="
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            >
              <option value="">All speakers</option>
              <option value="officer">Officers only</option>
              <option value="civilian">Civilians only</option>
            </select>
          </div>
          <div>
            <label
              style="display: block; margin-bottom: 0.5rem; font-weight: 600"
              >Date Range</label
            >
            <input
              type="date"
              id="dateFilter"
              style="
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            />
          </div>
        </div>

        <div class="search-filters" id="activeFilters"></div>
      </div>

      <div class="results-container" id="resultsContainer">
        <div class="stats-bar" id="statsBar" style="display: none">
          <div class="stat-item">
            <strong id="totalResults">0</strong> results found
          </div>
          <div class="stat-item">
            Across <strong id="totalAnalyses">0</strong> analyses
          </div>
          <div class="stat-item">
            Search time: <strong id="searchTime">0</strong>ms
          </div>
        </div>

        <div id="resultsList">
          <div class="no-results">
            <p style="font-size: 1.125rem; margin-bottom: 0.5rem">
              üîç No search performed
            </p>
            <p style="margin: 0">
              Enter keywords above to search across all your BWC transcripts
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Sample data - In production, this would come from API
      const sampleTranscripts = [
        {
          analysisId: "abc123",
          caseNumber: "ATL-L-002794-25",
          timestamp: "0:04:32",
          speaker: "Officer Smith",
          speakerType: "officer",
          text: "Subject is approximately 6 feet tall, wearing a blue jacket. We are at the corner of Main Street and 5th Avenue.",
          date: "2025-01-15",
        },
        {
          analysisId: "abc123",
          caseNumber: "ATL-L-002794-25",
          timestamp: "0:05:45",
          speaker: "Dispatch",
          speakerType: "officer",
          text: "Copy that Unit 23, backup is en route to Main Street and 5th Avenue.",
          date: "2025-01-15",
        },
        {
          analysisId: "def456",
          caseNumber: "USDJ 1:25-cv-15641",
          timestamp: "0:12:20",
          speaker: "Officer Johnson",
          speakerType: "officer",
          text: "I am detaining the subject for investigation. Subject states his name is John Doe.",
          date: "2025-02-03",
        },
        {
          analysisId: "def456",
          caseNumber: "USDJ 1:25-cv-15641",
          timestamp: "0:12:45",
          speaker: "Civilian",
          speakerType: "civilian",
          text: "I did not do anything wrong. I was just walking home.",
          date: "2025-02-03",
        },
      ];

      let currentResults = [];

      function performSearch() {
        const startTime = performance.now();
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        const caseFilter = document
          .getElementById("caseFilter")
          .value.toLowerCase();
        const speakerFilter = document.getElementById("speakerFilter").value;
        const dateFilter = document.getElementById("dateFilter").value;

        if (!query) {
          alert("Please enter a search term");
          return;
        }

        // Filter transcripts
        currentResults = sampleTranscripts.filter((item) => {
          const matchesQuery =
            item.text.toLowerCase().includes(query) ||
            item.speaker.toLowerCase().includes(query) ||
            item.caseNumber.toLowerCase().includes(query);

          const matchesCase =
            !caseFilter || item.caseNumber.toLowerCase().includes(caseFilter);
          const matchesSpeaker =
            !speakerFilter || item.speakerType === speakerFilter;
          const matchesDate = !dateFilter || item.date === dateFilter;

          return matchesQuery && matchesCase && matchesSpeaker && matchesDate;
        });

        const endTime = performance.now();
        const searchTime = Math.round(endTime - startTime);

        displayResults(query, searchTime);
      }

      function displayResults(query, searchTime) {
        const statsBar = document.getElementById("statsBar");
        const resultsList = document.getElementById("resultsList");

        if (currentResults.length === 0) {
          statsBar.style.display = "none";
          resultsList.innerHTML = `
                    <div class="no-results">
                        <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">üòï No results found</p>
                        <p style="margin: 0;">Try different keywords or adjust your filters</p>
                    </div>
                `;
          return;
        }

        // Update stats
        statsBar.style.display = "flex";
        document.getElementById("totalResults").textContent =
          currentResults.length;
        document.getElementById("totalAnalyses").textContent = new Set(
          currentResults.map((r) => r.analysisId),
        ).size;
        document.getElementById("searchTime").textContent = searchTime;

        // Display results
        resultsList.innerHTML = currentResults
          .map((result) => {
            const highlightedText = highlightQuery(result.text, query);

            return `
                    <div class="result-item">
                        <div class="result-meta">
                            <span class="timestamp">üïê ${result.timestamp}</span>
                            <span class="speaker-badge">${result.speaker}</span>
                            <span>üìÅ ${result.caseNumber}</span>
                            <span>üìÖ ${result.date}</span>
                        </div>
                        <div class="result-text">${highlightedText}</div>
                        <div style="margin-top: 0.75rem;">
                            <a href="/api/analysis/${result.analysisId}" class="btn btn-sm btn-secondary">View Full Analysis</a>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function highlightQuery(text, query) {
        const regex = new RegExp(`(${escapeRegex(query)})`, "gi");
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      // Enter key to search
      document
        .getElementById("searchInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            performSearch();
          }
        });

      // Auto-search on filter change
      ["caseFilter", "speakerFilter", "dateFilter"].forEach((id) => {
        document.getElementById(id).addEventListener("change", () => {
          if (document.getElementById("searchInput").value) {
            performSearch();
          }
        });
      });
    </script>
  </body>
</html>

<!-- Premium Upload & AI Chat Panel -->
<div id="aiPanel" class="ai-panel-glass animate-fade-in">
  <div class="ai-panel-header" onclick="toggleAIPanel()">
    <span class="ai-panel-title">üß† AI Analysis Assistant</span>
    <span class="ai-panel-toggle" id="aiPanelToggle">‚ñ≤</span>
  </div>
  <div class="ai-panel-body" id="aiPanelBody">
    <div class="ai-upload-area" id="aiUploadArea">
      <div class="ai-upload-icon">üìÑ</div>
      <div class="ai-upload-label">Upload PDF or Video</div>
      <input type="file" id="aiFileInput" accept=".pdf,.mp4,.mov,.avi" />
      <div class="ai-upload-status" id="aiUploadStatus"></div>
    </div>
    <div class="ai-api-key-row">
      <input
        id="aiApiKeyInput"
        type="password"
        placeholder="Paste your OpenAI API key (optional)"
      />
      <button id="aiApiKeySave" class="btn btn-secondary">
        Use My API Key
      </button>
      <div id="aiApiKeyStatus"></div>
    </div>
    <div class="ai-chat-messages" id="aiChatMessages"></div>
    <form id="aiChatForm" class="ai-chat-form">
      <input
        id="aiChatInput"
        type="text"
        placeholder="Ask a question..."
        autocomplete="off"
      />
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>
</div>
<style>
  .ai-panel-glass {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 400px;
    max-width: 98vw;
    background: rgba(255, 255, 255, 0.85);
    box-shadow:
      0 8px 32px rgba(30, 64, 175, 0.18),
      0 1.5px 8px rgba(0, 0, 0, 0.08);
    border-radius: 18px;
    overflow: hidden;
    z-index: 9999;
    backdrop-filter: blur(18px) saturate(160%);
    border: 1.5px solid rgba(59, 130, 246, 0.12);
    display: flex;
    flex-direction: column;
    transition:
      box-shadow 0.3s,
      background 0.3s;
  }
  .ai-panel-header {
    background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
    color: #fff;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 1rem 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    letter-spacing: 0.01em;
  }
  .ai-panel-title {
    font-size: 1.1rem;
  }
  .ai-panel-toggle {
    font-size: 1.2rem;
    transition: transform 0.3s;
  }
  .ai-panel-body {
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.92);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .ai-upload-area {
    border: 2px dashed #3b82f6;
    border-radius: 12px;
    background: rgba(59, 130, 246, 0.04);
    padding: 1.5rem 1rem;
    text-align: center;
    margin-bottom: 0.5rem;
    transition:
      border-color 0.2s,
      background 0.2s;
    position: relative;
  }
  .ai-upload-area.dragover {
    border-color: #06b6d4;
    background: rgba(6, 182, 212, 0.08);
  }
  .ai-upload-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: #3b82f6;
  }
  .ai-upload-label {
    font-size: 1rem;
    color: #1e3a8a;
    margin-bottom: 0.5rem;
  }
  .ai-upload-status {
    font-size: 0.95rem;
    color: #10b981;
    margin-top: 0.5rem;
    min-height: 1.2em;
  }
  .ai-upload-area input[type="file"] {
    opacity: 0;
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }
  .ai-api-key-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .ai-api-key-row input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 0.98rem;
  }
  .ai-api-key-row button {
    min-width: 120px;
  }
  .ai-api-key-row #aiApiKeyStatus {
    font-size: 0.85rem;
    color: #888;
    margin-left: 0.5rem;
  }
  .ai-chat-messages {
    background: rgba(243, 244, 246, 0.7);
    border-radius: 10px;
    min-height: 120px;
    max-height: 180px;
    overflow-y: auto;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    color: #222;
    box-shadow: 0 1px 4px rgba(59, 130, 246, 0.04);
  }
  .ai-chat-form {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .ai-chat-form input[type="text"] {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
  }
  .ai-chat-form button {
    min-width: 100px;
  }
  @media (max-width: 600px) {
    .ai-panel-glass {
      right: 1vw;
      left: 1vw;
      width: 98vw;
      min-width: unset;
    }
    .ai-panel-body {
      padding: 0.75rem;
    }
  }
</style>
<script>
  function toggleAIPanel() {
    const body = document.getElementById("aiPanelBody");
    const toggle = document.getElementById("aiPanelToggle");
    if (body.style.display === "none") {
      body.style.display = "flex";
      toggle.textContent = "‚ñ≤";
    } else {
      body.style.display = "none";
      toggle.textContent = "‚ñº";
    }
  }
  // Drag-and-drop upload
  const uploadArea = document.getElementById("aiUploadArea");
  const fileInput = document.getElementById("aiFileInput");
  const uploadStatus = document.getElementById("aiUploadStatus");
  uploadArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadArea.classList.add("dragover");
  });
  uploadArea.addEventListener("dragleave", (e) => {
    uploadArea.classList.remove("dragover");
  });
  uploadArea.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadArea.classList.remove("dragover");
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      handleFileUpload(e.dataTransfer.files[0]);
    }
  });
  fileInput.addEventListener("change", (e) => {
    if (fileInput.files.length) handleFileUpload(fileInput.files[0]);
  });
  function handleFileUpload(file) {
    uploadStatus.textContent = "Uploading...";
    const formData = new FormData();
    formData.append("file", file);
    const isPDF = file.name.toLowerCase().endsWith(".pdf");
    const url = isPDF ? "/api/upload/pdf" : "/api/upload/video";
    fetch(url, { method: "POST", body: formData })
      .then((r) => r.json())
      .then((data) => {
        if (data.error) {
          uploadStatus.textContent = data.error;
        } else {
          uploadStatus.textContent = "Uploaded: " + data.filename;
          window.aiContext = isPDF ? data.text : data.transcript;
        }
      })
      .catch(() => {
        uploadStatus.textContent = "Upload failed.";
      });
  }
  // API key logic
  document.getElementById("aiApiKeySave").onclick = function (e) {
    e.preventDefault();
    const key = document.getElementById("aiApiKeyInput").value.trim();
    if (!key) {
      document.getElementById("aiApiKeyStatus").textContent = "No key entered.";
      return;
    }
    localStorage.setItem("openai_api_key", key);
    document.getElementById("aiApiKeyStatus").textContent =
      "API key saved for this browser session.";
  };
  // Chat logic
  document.getElementById("aiChatForm").onsubmit = async function (e) {
    e.preventDefault();
    const input = document.getElementById("aiChatInput");
    const messages = document.getElementById("aiChatMessages");
    const userMsg = input.value.trim();
    if (!userMsg) return;
    messages.innerHTML += `<div style='margin-bottom:0.5rem;'><b>You:</b> ${userMsg}</div>`;
    input.value = "";
    messages.scrollTop = messages.scrollHeight;
    messages.innerHTML += `<div style='margin-bottom:0.5rem; color: #888;'><b>AI:</b> <span>Thinking...</span></div>`;
    messages.scrollTop = messages.scrollHeight;
    try {
      const apiKey = localStorage.getItem("openai_api_key") || "";
      const context = window.aiContext || "";
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: userMsg, context, api_key: apiKey }),
      });
      const data = await res.json();
      messages.innerHTML = messages.innerHTML.replace(
        "Thinking...",
        data.answer || "No response.",
      );
    } catch (err) {
      messages.innerHTML = messages.innerHTML.replace(
        "Thinking...",
        "Error contacting AI.",
      );
    }
    messages.scrollTop = messages.scrollHeight;
  };
</script>
