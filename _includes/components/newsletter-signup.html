<!doctype html>
{%- comment -%} NEWSLETTER SIGNUP FORM - Optimized Double opt-in support,
validation, and success states Supports Mailchimp, ConvertKit, Buttondown, and
custom endpoints {%- endcomment -%} {% if site.newsletter_enabled %}
<aside
  class="newsletter-signup animate-fade-in-up"
  id="newsletter-signup"
  style="
  padding: 2.5rem;
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(37, 99, 235, 0.1));
  border: 2px solid var(--color-primary, #dc2626);
  border-radius: var(--radius-lg, 12px);
  margin: {{ include.margin | default: '3rem 0' }};
  position: relative;
  overflow: hidden;
"
>
  <!-- Decorative background pattern -->
  <div
    aria-hidden="true"
    style="
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(
        circle,
        rgba(220, 38, 38, 0.15) 0%,
        transparent 70%
      );
      border-radius: 50%;
      pointer-events: none;
    "
  ></div>

  <div
    style="
      position: relative;
      z-index: 1;
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    "
  >
    <div
      class="newsletter-icon"
      aria-hidden="true"
      style="
        font-size: 3rem;
        margin-bottom: 1rem;
        filter: drop-shadow(0 4px 8px rgba(220, 38, 38, 0.3));
      "
    >
      ðŸ“¬
    </div>

    <h3
      class="newsletter-title"
      style="
        font-size: clamp(1.5rem, 3vw, 2rem);
        margin: 0 0 0.75rem 0;
        color: var(--color-text-primary, white);
        font-weight: 700;
      "
    >
      {{ include.title | default: site.newsletter_title | default: "Stay
      Updated" }}
    </h3>

    <p
      class="newsletter-description"
      style="
        font-size: 1.05rem;
        line-height: 1.6;
        color: var(--color-text-muted, rgba(255, 255, 255, 0.8));
        margin: 0 0 2rem 0;
      "
    >
      {{ include.description | default: site.newsletter_description | default:
      "Get the latest updates, insights, and case analysis delivered straight to
      your inbox." }}
    </p>

    <form
      class="newsletter-form"
      name="newsletter-signup"
      method="POST"
      data-netlify="true"
      netlify-honeypot="bot-field"
      action="/thank-you/newsletter/"
      id="newsletter-form-element"
      style="
        display: flex;
        gap: 0.75rem;
        max-width: 500px;
        margin: 0 auto;
        flex-wrap: wrap;
      "
    >
      <!-- Netlify Forms requirement -->
      <input type="hidden" name="form-name" value="newsletter-signup" />

      <!-- Honeypot for spam protection -->
      <div
        class="hidden"
        style="position: absolute; left: -5000px"
        aria-hidden="true"
      >
        <label
          >Don't fill this out if you're human:
          <input name="bot-field" tabindex="-1"
        /></label>
      </div>

      <div style="flex: 1; min-width: 250px; position: relative">
        <label for="newsletter-email" class="sr-only">Email address</label>
        <input
          type="email"
          name="email"
          id="newsletter-email"
          placeholder="your.email@example.com"
          required
          aria-label="Email address"
          aria-describedby="newsletter-error"
          aria-invalid="false"
          style="
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md, 8px);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            transition: all 0.2s;
            outline: none;
          "
        />
        <div
          id="newsletter-error"
          class="newsletter-error"
          role="alert"
          aria-live="polite"
          style="
            display: none;
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            text-align: left;
          "
        ></div>
      </div>

      <button
        type="submit"
        class="newsletter-submit"
        aria-label="Subscribe to newsletter"
        style="
          padding: 1rem 2rem;
          background: linear-gradient(
            135deg,
            var(--color-primary, #dc2626),
            var(--color-accent, #2563eb)
          );
          color: white;
          border: none;
          border-radius: var(--radius-md, 8px);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
          position: relative;
        "
      >
        <span class="btn-text">Subscribe â†’</span>
        <span class="btn-loading" style="display: none">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            style="animation: spin 1s linear infinite"
          >
            <circle cx="12" cy="12" r="10" opacity="0.25" />
            <path d="M12 2a10 10 0 0 1 10 10" opacity="0.75" />
          </svg>
        </span>
      </button>
    </form>

    <!-- Success Message -->
    <div
      id="newsletter-success"
      class="newsletter-success"
      role="alert"
      aria-live="polite"
      style="
        display: none;
        margin-top: 1.5rem;
        padding: 1rem;
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid rgba(16, 185, 129, 0.4);
        border-radius: var(--radius-md, 8px);
        color: rgba(16, 185, 129, 1);
      "
    >
      <strong>âœ“ Success!</strong> Check your email to confirm your subscription.
    </div>

    <p
      style="
        margin: 1rem 0 0 0;
        font-size: 0.85rem;
        color: var(--color-text-muted, rgba(255, 255, 255, 0.6));
      "
    >
      No spam, unsubscribe anytime. Read our
      <a
        href="{{ site.privacy_policy_url | default: '/privacy-policy/' }}"
        style="color: var(--color-accent, #60a5fa); text-decoration: underline"
        >privacy policy</a
      >.
    </p>
  </div>
</aside>

<script>
  (function() {
    const form = document.getElementById('newsletter-form-element');
    const emailInput = document.getElementById('newsletter-email');
    const submitBtn = form.querySelector('.newsletter-submit');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const errorDiv = document.getElementById('newsletter-error');
    const successDiv = document.getElementById('newsletter-success');

    // Email validation
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      emailInput.setAttribute('aria-invalid', 'true');
      emailInput.style.borderColor = '#ef4444';
    }

    function hideError() {
      errorDiv.style.display = 'none';
      emailInput.setAttribute('aria-invalid', 'false');
      emailInput.style.borderColor = 'rgba(255, 255, 255, 0.2)';
    }

    function showSuccess() {
      successDiv.style.display = 'block';
      form.style.display = 'none';
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-block';
        submitBtn.style.cursor = 'wait';
      } else {
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        submitBtn.style.cursor = 'pointer';
      }
    }

    // Input event - clear error on typing
    emailInput.addEventListener('input', hideError);

    // Focus events
    emailInput.addEventListener('focus', function() {
      this.style.borderColor = 'var(--color-primary, #dc2626)';
      this.style.background = 'rgba(0, 0, 0, 0.5)';
    });

    emailInput.addEventListener('blur', function() {
      if (!this.value) {
        this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        this.style.background = 'rgba(0, 0, 0, 0.3)';
      }
    });

    // Submit handler
    form.addEventListener('submit', function(e) {
      hideError();

      const email = emailInput.value.trim();

      if (!email) {
        e.preventDefault();
        showError('Please enter your email address');
        emailInput.focus();
        return;
      }

      if (!isValidEmail(email)) {
        e.preventDefault();
        showError('Please enter a valid email address');
        emailInput.focus();
        return;
      }

      {% if site.newsletter_provider == 'custom' %}
      e.preventDefault();
      setLoading(true);

      // Custom AJAX submission
      fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
      })
      .then(response => response.json())
      .then(data => {
        setLoading(false);
        if (data.success) {
          showSuccess();
          // Track conversion
          if (typeof gtag === 'function') {
            gtag('event', 'newsletter_signup', {
              'event_category': 'Newsletter',
              'event_label': email
            });
          }
        } else {
          showError(data.message || 'Something went wrong. Please try again.');
        }
      })
      .catch(error => {
        setLoading(false);
        showError('Network error. Please check your connection and try again.');
      });
      {% else %}
      // Track conversion for Mailchimp/ConvertKit
      if (typeof gtag === 'function') {
        gtag('event', 'newsletter_signup', {
          'event_category': 'Newsletter',
          'event_label': email
        });
      }
      {% endif %}
    });

    // Hover effects
    submitBtn.addEventListener('mouseenter', function() {
      if (!this.disabled) {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 6px 20px rgba(220, 38, 38, 0.5)';
      }
    });

    submitBtn.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '0 4px 12px rgba(220, 38, 38, 0.3)';
    });
  })();
</script>

<style>
  .newsletter-form input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  @media (max-width: 600px) {
    .newsletter-signup {
      padding: 1.5rem;
    }

    .newsletter-form {
      flex-direction: column;
    }

    .newsletter-form button {
      width: 100%;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .newsletter-signup,
    .newsletter-submit {
      transition: none !important;
    }

    @keyframes spin {
      to {
        transform: none;
      }
    }
  }
</style>
{% endif %}
