# Copyright © 2024–2026 Faith Frontier Ecclesiastical Trust. All rights reserved.
# PROPRIETARY — See LICENSE.

name: Mobile CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - "src/Evident.Mobile/**"
      - "src/Evident.Shared/**"
      - ".github/workflows/mobile-ci.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/Evident.Mobile/**"
      - "src/Evident.Shared/**"

env:
  DOTNET_VERSION: "9.0.x"
  MAUI_VERSION: "10.0.x"

jobs:
  build-test:
    name: Build and Test
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore src/Evident.Mobile/Evident.Mobile.csproj

      - name: Build
        run: dotnet build src/Evident.Mobile/Evident.Mobile.csproj --configuration Release --no-restore

      - name: Run unit tests
        run: dotnet test tests/Evident.Mobile.Tests/Evident.Mobile.Tests.csproj --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: "**/coverage.cobertura.xml"
          flags: mobile

  build-android:
    name: Build Android
    runs-on: windows-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui-android

      - name: Restore dependencies
        run: dotnet restore src/Evident.Mobile/Evident.Mobile.csproj

      - name: Build Android APK
        run: dotnet publish src/Evident.Mobile/Evident.Mobile.csproj -f net10.0-android -c Release -p:AndroidPackageFormat=apk

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: src/Evident.Mobile/bin/Release/net10.0-android/publish/*.apk
          retention-days: 30

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui-ios

      - name: Restore dependencies
        run: dotnet restore src/Evident.Mobile/Evident.Mobile.csproj

      - name: Build iOS
        run: dotnet build src/Evident.Mobile/Evident.Mobile.csproj -f net10.0-ios -c Release

      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: src/Evident.Mobile/bin/Release/net10.0-ios/
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui-windows

      - name: Restore dependencies
        run: dotnet restore src/Evident.Mobile/Evident.Mobile.csproj

      - name: Build Windows
        run: dotnet build src/Evident.Mobile/Evident.Mobile.csproj -f net10.0-windows10.0.19041.0 -c Release

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: src/Evident.Mobile/bin/Release/net10.0-windows10.0.19041.0/
          retention-days: 30
