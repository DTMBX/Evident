{%- comment -%} ANALYTICS & PERFORMANCE TRACKING - Optimized Privacy-first
analytics with consent integration Supports GA4, Plausible, Fathom, and custom
tracking {%- endcomment -%} {% if site.analytics_id and page.track_analytics !=
false %} {%- comment -%} Initialize consent state {%- endcomment -%}
<script>
  window.analyticsConsent = localStorage.getItem("cookie_consent")
    ? JSON.parse(localStorage.getItem("cookie_consent")).value === "accepted"
    : false;
</script>

{% if site.analytics_provider == 'google' or site.analytics_provider == 'ga4' %}
<!-- Google Analytics 4 (Privacy-Enhanced) -->
<script
  async
  src="https://www.googletagmanager.com/gtag/js?id={{ site.analytics_id }}"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}

  // Set default consent state
  gtag('consent', 'default', {
    'analytics_storage': window.analyticsConsent ? 'granted' : 'denied',
    'ad_storage': 'denied',
    'wait_for_update': 500
  });

  gtag('js', new Date());
  gtag('config', '{{ site.analytics_id }}', {
    'anonymize_ip': {{ site.analytics_anonymize_ip | default: true }},
    'cookie_flags': 'SameSite=None;Secure',
    'cookie_expires': {{ site.analytics_cookie_expires | default: 63072000 }},
    'send_page_view': true,
    'page_title': '{{ page.title | default: site.title }}',
    'page_location': '{{ page.url | absolute_url }}',
    'content_group': '{{ page.collection | default: "pages" }}'
  });

  // Track outbound links
  document.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (link && link.hostname !== window.location.hostname && window.analyticsConsent) {
      gtag('event', 'click', {
        'event_category': 'Outbound Link',
        'event_label': link.href,
        'transport_type': 'beacon'
      });
    }
  });

  // Track downloads
  document.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (link && /\.(pdf|doc|docx|zip|xlsx|xls)$/i.test(link.href) && window.analyticsConsent) {
      gtag('event', 'file_download', {
        'event_category': 'Downloads',
        'event_label': link.href,
        'file_extension': link.href.split('.').pop().toLowerCase()
      });
    }
  });
</script>

{% elsif site.analytics_provider == 'plausible' %}
<!-- Plausible Analytics (Privacy-Friendly) -->
<script
  defer
  data-domain="{{ site.url | remove: 'http://' | remove: 'https://' | remove: 'www.' }}"
  src="https://plausible.io/js/{{ site.plausible_script | default: 'plausible' }}.js"
></script>
<script>
  window.plausible =
    window.plausible ||
    function () {
      (window.plausible.q = window.plausible.q || []).push(arguments);
    };
</script>

{% elsif site.analytics_provider == 'fathom' %}
<!-- Fathom Analytics (Privacy-First) -->
<script
  src="https://cdn.usefathom.com/script.js"
  data-site="{{ site.analytics_id }}"
  defer
></script>

{% elsif site.analytics_provider == 'custom' %}
<!-- Custom Analytics Code -->
{{ site.custom_analytics_code }} {% endif %}

<!-- Performance Monitoring (Enhanced) -->
{% if site.enable_performance_monitoring %}
<script>
  // Use modern Performance Observer API
  if ('PerformanceObserver' in window) {
    // Largest Contentful Paint
    try {
      const lcpObserver = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const lastEntry = entries[entries.length - 1];

        if (typeof gtag === 'function' && window.analyticsConsent) {
          gtag('event', 'web_vitals', {
            'event_category': 'Web Vitals',
            'event_label': 'LCP',
            'value': Math.round(lastEntry.renderTime || lastEntry.loadTime),
            'metric_id': 'lcp',
            'non_interaction': true
          });
        }
      });
      lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
    } catch (e) {}

    // First Input Delay
    try {
      const fidObserver = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        entries.forEach((entry) => {
          if (typeof gtag === 'function' && window.analyticsConsent) {
            gtag('event', 'web_vitals', {
              'event_category': 'Web Vitals',
              'event_label': 'FID',
              'value': Math.round(entry.processingStart - entry.startTime),
              'metric_id': 'fid',
              'non_interaction': true
            });
          }
        });
      });
      fidObserver.observe({ entryTypes: ['first-input'] });
    } catch (e) {}

    // Cumulative Layout Shift
    try {
      let clsValue = 0;
      const clsObserver = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput) {
            clsValue += entry.value;
          }
        }
      });
      clsObserver.observe({ entryTypes: ['layout-shift'] });

      // Report on page unload
      window.addEventListener('beforeunload', () => {
        if (typeof gtag === 'function' && window.analyticsConsent) {
          gtag('event', 'web_vitals', {
            'event_category': 'Web Vitals',
            'event_label': 'CLS',
            'value': Math.round(clsValue * 1000),
            'metric_id': 'cls',
            'non_interaction': true
          });
        }
      });
    } catch (e) {}
  }

  // Fallback to Navigation Timing API
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (window.performance && window.performance.timing) {
        const perfData = window.performance.timing;
        const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
        const dnsTime = perfData.domainLookupEnd - perfData.domainLookupStart;
        const tcpTime = perfData.connectEnd - perfData.connectStart;
        const ttfb = perfData.responseStart - perfData.navigationStart;
        const domInteractive = perfData.domInteractive - perfData.navigationStart;

        if (typeof gtag === 'function' && window.analyticsConsent) {
          gtag('event', 'timing_complete', {
            'event_category': 'Performance',
            'name': 'page_load',
            'value': pageLoadTime,
            'page_path': '{{ page.url }}',
            'dns_time': dnsTime,
            'tcp_time': tcpTime,
            'ttfb': ttfb,
            'dom_interactive': domInteractive,
            'non_interaction': true
          });
        }

        // Log to console in development
        {% if jekyll.environment == 'development' %}
        console.log('Performance Metrics:', {
          'Page Load Time': pageLoadTime + 'ms',
          'DNS Lookup': dnsTime + 'ms',
          'TCP Connection': tcpTime + 'ms',
          'Time to First Byte': ttfb + 'ms',
          'DOM Interactive': domInteractive + 'ms'
        });
        {% endif %}
      }
    }, 0);
  });
</script>
{% endif %}

<!-- Error Tracking -->
{% if site.enable_error_tracking %}
<script>
  window.addEventListener("error", function (e) {
    if (typeof gtag === "function" && window.analyticsConsent) {
      gtag("event", "exception", {
        description: e.message + " @ " + e.filename + ":" + e.lineno,
        fatal: false,
        page_path: "{{ page.url }}",
      });
    }
  });
</script>
{% endif %} {% endif %}
