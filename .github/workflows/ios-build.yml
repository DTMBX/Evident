# Copyright Â© 2024â€“2026 Faith Frontier Ecclesiastical Trust. All rights reserved.
# PROPRIETARY â€” See LICENSE.

name: iOS Build

on:
  push:
    branches: [main, develop]
  workflow_dispatch: # Manual trigger

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Check Xcode version
        id: xcode-check
        run: |
          set -euo pipefail
          REQUIRED="26.2"
          INSTALLED_FULL=$(xcodebuild -version | head -n1 || true)
          INSTALLED=$(echo "$INSTALLED_FULL" | awk '{print $2}')
          echo "Installed Xcode: ${INSTALLED_FULL}"
          if [ "${INSTALLED}" = "${REQUIRED}" ]; then
            echo "xcode_ok=true" >> $GITHUB_OUTPUT
          else
            echo "xcode_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip iOS build if Xcode mismatch
        if: steps.xcode-check.outputs.xcode_ok != 'true'
        run: |
          echo "::warning::Required Xcode 26.2 not found. Skipping iOS build on this runner."
          echo "To run iOS builds: use a runner with Xcode 26.2, or trigger this workflow manually on an appropriate self-hosted/macOS runner."
          exit 0
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore src/Evident.MatterDocket.MAUI/Evident.MatterDocket.MAUI.csproj

      - name: Build iOS app (Development)
        if: steps.xcode-check.outputs.xcode_ok == 'true'
        run: |
          dotnet build src/Evident.MatterDocket.MAUI/Evident.MatterDocket.MAUI.csproj \
            -f net10.0-ios \
            -c Debug \
            /p:RuntimeIdentifier=ios-arm64 \
            /p:BuildIpa=true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v6
        with:
          name: Evident-iOS-Development
          path: |
            src/Evident.MatterDocket.MAUI/bin/Debug/net10.0-ios/ios-arm64/**/*.ipa
            src/Evident.MatterDocket.MAUI/bin/Debug/net10.0-ios/ios-arm64/**/*.app
          retention-days: 30

      - name: Build summary
        run: |
          echo "âœ… iOS build complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Download the IPA from the Artifacts section above" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± Install via Xcode or Apple Configurator" >> $GITHUB_STEP_SUMMARY
