<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:BarberX.Mobile.ViewModels"
             x:Class="BarberX.Mobile.Views.AnalysisListPage"
             x:DataType="viewmodels:AnalysisListViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*">
        
        <!-- Header with Upload Button -->
        <Frame Grid.Row="0" BackgroundColor="#0f172a" Padding="20" HasShadow="False">
            <Grid ColumnDefinitions="*,Auto">
                <Label Grid.Column="0" 
                       Text="My Analyses"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="White"
                       VerticalOptions="Center"/>
                
                <Button Grid.Column="1"
                        Text="+ Upload"
                        Command="{Binding UploadNewCommand}"
                        BackgroundColor="#3b82f6"
                        TextColor="White"
                        CornerRadius="8"
                        Padding="20,10"/>
            </Grid>
        </Frame>

        <!-- Analysis List -->
        <RefreshView Grid.Row="1"
                     Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsBusy}">
            
            <CollectionView ItemsSource="{Binding Analyses}"
                           SelectionMode="None"
                           EmptyView="No analyses yet. Upload a video to get started!">
                
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <!-- Swipe Actions -->
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Delete"
                                              BackgroundColor="#ef4444"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AnalysisListViewModel}}, Path=DeleteAnalysisCommand}"
                                              CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.RightItems>
                            
                            <!-- Analysis Card -->
                            <Frame Margin="16,8" 
                                   Padding="16"
                                   BackgroundColor="White"
                                   CornerRadius="12"
                                   HasShadow="True">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AnalysisListViewModel}}, Path=ViewAnalysisCommand}"
                                                         CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>
                                
                                <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                                    
                                    <!-- File Name -->
                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding FileName}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="#0f172a"/>
                                    
                                    <!-- Status Badge -->
                                    <Frame Grid.Row="0" Grid.Column="1"
                                           Padding="8,4"
                                           CornerRadius="12"
                                           HasShadow="False"
                                           BackgroundColor="{Binding Status, Converter={StaticResource StatusColorConverter}}">
                                        <Label Text="{Binding Status}"
                                               FontSize="12"
                                               TextColor="White"
                                               FontAttributes="Bold"/>
                                    </Frame>
                                    
                                    <!-- Case Number -->
                                    <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding CaseNumber, StringFormat='Case: {0}'}"
                                           FontSize="14"
                                           TextColor="#64748b"
                                           Margin="0,4,0,0"
                                           IsVisible="{Binding CaseNumber, Converter={StaticResource StringNotEmptyConverter}}"/>
                                    
                                    <!-- Progress Bar -->
                                    <ProgressBar Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                Progress="{Binding Progress, Converter={StaticResource PercentToDecimalConverter}}"
                                                ProgressColor="#3b82f6"
                                                Margin="0,8,0,0"
                                                IsVisible="{Binding Status, Converter={StaticResource IsProcessingConverter}}"/>
                                    
                                    <!-- Date -->
                                    <Label Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding CreatedAt, StringFormat='{0:MMM dd, yyyy h:mm tt}'}"
                                           FontSize="12"
                                           TextColor="#94a3b8"
                                           Margin="0,4,0,0"/>
                                    
                                </Grid>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
            </CollectionView>
        </RefreshView>
        
    </Grid>
    
</ContentPage>
