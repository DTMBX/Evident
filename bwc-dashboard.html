<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BWC Analysis Dashboard | BarberX Legal Tech</title>
    <link rel="stylesheet" href="/assets/css/legal-tech-platform.css" />
    <style>
      .dashboard-container {
          max-width: 1600px;
          margin: 2rem auto;
          padding: 0 2rem;
      }

      .dashboard-header {
          margin-bottom: 3rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 1rem;
      }

      .header-left h1 {
          font-size: 2.5rem;
          color: var(--text-primary);
          margin-bottom: 0.5rem;
      }

      .header-right {
          display: flex;
          gap: 1rem;
          align-items: center;
      }

      .filter-dropdown {
          padding: 0.625rem 1rem;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          background: var(--surface-color);
          color: var(--text-primary);
          font-size: 0.875rem;
          cursor: pointer;
      }

      .breadcrumb {
          font-size: 0.875rem;
          color: var(--text-secondary);
      }

      .breadcrumb a {
          color: var(--accent-blue);
          text-decoration: none;
      }

      /* Stats Overview */
      .stats-overview {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
      }

      .stat-card {
          background: var(--surface-color);
          padding: 1.5rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
          border-left: 4px solid var(--accent-blue);
      }

      .stat-card.warning {
          border-left-color: #f59e0b;
      }

      .stat-card.success {
          border-left-color: #10b981;
      }

      .stat-card.danger {
          border-left-color: #ef4444;
      }

      .stat-number {
          font-size: 2.5rem;
          font-weight: 700;
          color: var(--accent-blue);
          margin-bottom: 0.25rem;
      }

      .stat-card.warning .stat-number {
          color: #f59e0b;
      }

      .stat-card.success .stat-number {
          color: #10b981;
      }

      .stat-card.danger .stat-number {
          color: #ef4444;
      }

      .stat-label {
          font-size: 0.875rem;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.05em;
      }

      /* Analysis Grid */
      .analyses-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
          gap: 2rem;
      }

      /* Analysis Card */
      .analysis-card {
          background: var(--surface-color);
          border-radius: 12px;
          padding: 2rem;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
          border: 1px solid var(--border-color);
          transition: all 0.3s ease;
      }

      .analysis-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }

      .analysis-card.analyzing {
          border-left: 4px solid var(--accent-blue);
      }

      .analysis-card.completed {
          border-left: 4px solid #10b981;
      }

      .analysis-card.failed {
          border-left: 4px solid #ef4444;
      }

      .card-header {
          display: flex;
          justify-content: space-between;
          align-items: start;
          margin-bottom: 1.5rem;
      }

      .card-title {
          flex: 1;
      }

      .card-title h3 {
          font-size: 1.25rem;
          color: var(--text-primary);
          margin-bottom: 0.5rem;
          word-break: break-word;
      }

      .card-meta {
          font-size: 0.875rem;
          color: var(--text-secondary);
      }

      .status-badge {
          padding: 0.5rem 1rem;
          border-radius: 20px;
          font-size: 0.875rem;
          font-weight: 600;
          text-transform: capitalize;
      }

      .status-badge.uploaded {
          background: #e0f2fe;
          color: #0369a1;
      }

      .status-badge.analyzing {
          background: #dbeafe;
          color: #1e40af;
          animation: pulse 2s infinite;
      }

      .status-badge.completed {
          background: #d1fae5;
          color: #065f46;
      }

      .status-badge.failed {
          background: #fee2e2;
          color: #991b1b;
      }

      @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.7; }
      }

      /* Progress Bar */
      .progress-section {
          margin-bottom: 1.5rem;
      }

      .progress-header {
          display: flex;
          justify-content: space-between;
          margin-bottom: 0.5rem;
      }

      .progress-label {
          font-size: 0.875rem;
          color: var(--text-secondary);
      }

      .progress-percent {
          font-size: 0.875rem;
          font-weight: 600;
          color: var(--accent-blue);
      }

      .progress-bar {
          width: 100%;
          height: 8px;
          background: var(--border-color);
          border-radius: 4px;
          overflow: hidden;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
          transition: width 0.5s ease;
          border-radius: 4px;
      }

      .current-step {
          margin-top: 0.5rem;
          font-size: 0.875rem;
          color: var(--text-secondary);
          font-style: italic;
      }

      /* Results Summary */
      .results-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
          margin-bottom: 1.5rem;
      }

      .result-item {
          background: var(--bg-color);
          padding: 1rem;
          border-radius: 8px;
          text-align: center;
          transition: transform 0.2s;
      }

      .result-item:hover {
          transform: translateY(-2px);
      }

      .result-value {
          font-size: 2rem;
          font-weight: 700;
          color: var(--accent-blue);
          margin-bottom: 0.25rem;
      }

      .result-label {
          font-size: 0.75rem;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.05em;
      }

      /* Timeline Preview */
      .timeline-preview {
          background: var(--bg-color);
          padding: 1rem;
          border-radius: 8px;
          margin-bottom: 1.5rem;
      }

      .timeline-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
      }

      .timeline-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: var(--text-primary);
      }

      .timeline-duration {
          font-size: 0.75rem;
          color: var(--text-secondary);
      }

      .timeline-bar {
          height: 40px;
          background: linear-gradient(to right, #e0f2fe 0%, #dbeafe 100%);
          border-radius: 6px;
          position: relative;
          overflow: hidden;
      }

      .timeline-segment {
          position: absolute;
          top: 0;
          height: 100%;
          border-right: 1px solid rgba(255, 255, 255, 0.5);
          transition: all 0.2s;
      }

      .timeline-segment:hover {
          opacity: 0.8;
      }

      .timeline-segment.speaker-0 {
          background: rgba(59, 130, 246, 0.6);
      }

      .timeline-segment.speaker-1 {
          background: rgba(6, 182, 212, 0.6);
      }

      .timeline-segment.speaker-2 {
          background: rgba(16, 185, 129, 0.6);
      }

      .timeline-segment.discrepancy {
          background: rgba(239, 68, 68, 0.8);
      }

      /* Quick Insights */
      .quick-insights {
          background: var(--bg-color);
          padding: 1rem;


      .btn-icon {
          background: transparent;
          border: 1px solid var(--border-color);
          color: var(--text-secondary);
          padding: 0.625rem;
      }

      .btn-icon:hover {
          background: var(--bg-color);
          border-color: var(--accent-blue);
          color: var(--accent-blue);
      }

      /* Detailed View Modal */
      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          overflow-y: auto;
          padding: 2rem;
      }

      .modal.active {
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .modal-content {
          background: var(--surface-color);
          border-radius: 12px;
          max-width: 1200px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
      }

      .modal-header {
          padding: 2rem;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: sticky;
          top: 0;
          background: var(--surface-color);
          z-index: 10;
      }

      .modal-header h2 {
          font-size: 1.75rem;
          color: var(--text-primary);
      }

      .modal-close {
          font-size: 2rem;
          color: var(--text-secondary);
          cursor: pointer;
          border: none;
          background: none;
          padding: 0.5rem;
          line-height: 1;
      }

      .modal-close:hover {
          color: var(--text-primary);
      }

      .modal-body {
          padding: 2rem;
      }

      .detail-section {
          margin-bottom: 2rem;
      }

      .detail-section h3 {
          font-size: 1.25rem;
          color: var(--text-primary);
          margin-bottom: 1rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .transcript-viewer {
          background: var(--bg-color);
          border-radius: 8px;
          padding: 1.5rem;
          max-height: 400px;
          overflow-y: auto;
      }

      .transcript-segment {
          padding: 1rem;
          margin-bottom: 1rem;
          background: var(--surface-color);
          border-left: 3px solid var(--accent-blue);
          border-radius: 4px;
      }

      .transcript-segment.discrepancy {
          border-left-color: #f59e0b;
          background: #fffbeb;
      }

      .segment-header {
          display: flex;
          justify-content: space-between;
          margin-bottom: 0.5rem;
          font-size: 0.875rem;
      }

      .segment-speaker {
          font-weight: 600;
          color: var(--accent-blue);
      }

      .segment-time {
          color: var(--text-secondary);
      }

      .segment-text {
          color: var(--text-primary);
          line-height: 1.6;
      }

      .speakers-list {
          display: grid;
          gap: 1rem;
      }

      .speaker-item {
          background: var(--bg-color);
          padding: 1.5rem;
          border-radius: 8px;
          display: flex;
          align-items: center;
          gap: 1rem;
      }

      .speaker-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          background: var(--accent-blue);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 1.25rem;
      }

      .speaker-info {
          flex: 1;header-left">
              <div class="breadcrumb">
                  <a href="/">Home</a> / <a href="/dashboard">Dashboard</a> / BWC Analysis
              </div>
              <h1>üé• BWC Analysis Dashboard</h1>
          </div>
          <div class="header-right">
              <select class="filter-dropdown" id="statusFilter" onchange="filterAnalyses()">
                  <option value="">All Status</option>
                  <option value="uploaded">Uploaded</option>
                  <option value="analyzing">Analyzing</option>
                  <option value="completed">Completed</option>
                  <option value="failed">Failed</option>
              </select>
              <select class="filter-dropdown" id="sortBy" onchange="sortAnalyses()">
                  <option value="recent">Most Recent</option>
                  <option value="oldest">Oldest First</option>
          filteredAnalyses = [];
      let updateInterval = null;

      async function loadAnalyses() {
          try {
              const response = await fetch('/api/analyses?per_page=100');
              const data = await response.json();
              analyses = data.analyses || [];
              filteredAnalyses = analyses;
              renderStats();
              renderAnalyses();
              startRealTimeUpdates();
          } catch (error) {
              console.error('Error loading analyses:', error);
              showError('Failed to load analyses');
          }
      }

      function renderStats() {
          const total = analyses.length;
          const analyzing = analyses.filter(a => a.status === 'analyzing').length;
          const completed = analyses.filter(a => a.status === 'completed').length;
          const totalDiscrepancies = analyses
              .filter(a => a.status === 'completed')
              .reduce((sum, a) => sum + (a.total_discrepancies || 0), 0);
          const criticalDiscrepancies = analyses
              .filter(a => a.status === 'completed')
              .reduce((sum, a) => sum + (a.critical_discrepancies || 0), 0);

          const statsHtml = `
              <div class="stat-card">
                  <div class="stat-number">${total}</div>
                  <div class="stat-label">Total Analyses</div>
              </div>
              <div class="stat-card warning">
                  <div class="stat-number">${analyzing}</div>
                  <div class="stat-label">In Progress</div>
              </div>
              <div class="stat-card success">
                  <div class="stat-number">${completed}</div>
                  <div class="stat-label">Completed</div>
              </div>
              <div class="stat-card ${criticalDiscrepancies > 0 ? 'danger' : ''}">
                  <div class="stat-number">${totalDiscrepancies}</div>
                  <div class="stat-label">Discrepancies Found</div>
              </div>
              <div class="stat-card ${criticalDiscrepancies > 0 ? 'danger' : ''}">
                  <div class="stat-number">${criticalDiscrepancies}</div>
                  <div class="stat-label">Critical Issues</div>
              </div>
          `;

          document.getElementById('statsOverview').innerHTML = statsHtml;
      }

      function filterAnalyses() {
          const status = document.getElementById('statusFilter').value;
          filteredAnalyses = status ? analyses.filter(a => a.status === status) : analyses;
          renderAnalyses();
      }

      function sortAnalyses() {
          const sortBy = document.getElementById('sortBy').value;

          if (sortBy === 'recent') {
              filteredAnalyses.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          } else if (sortBy === 'oldest') {
              filteredAnalyses.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          } else if (sortBy === 'name') {
              filteredAnalyses.sort((a, b) => a.filename.localeCompare(b.filename));
          }

          renderAnalyses();
      }

      function renderAnalyses() {
          const grid = document.getElementById('analysesGrid');

          if (filteredAnalyses.length === 0) {
              grid.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">üé•</div>
                      <h3>No Analyses Found</h3>
                      <p>${analyses.length === 0 ? 'Upload a BWC video to get started with forensic analysis' : 'Try adjusting your filters'}</p>
                      <a href="/analyzer" class="btn btn-primary">Upload Video</a>
                  </div>
              `;
              return;
          }

          grid.innerHTML = filteredA
          display: flex;
          align-items: start;
          gap: 0.75rem;
          padding: 0.75rem 0;
          border-bottom: 1px solid var(--border-color);
      }

      .insight-item:last-child {
          border-bottom: none;
      }

      .insight-icon {
          font-size: 1.25rem;
          flex-shrink: 0;
      }

      .insight-text {
          font-size: 0.875rem;
          color: var(--text-secondary);
          line-height: 1.6;
      }

      .insight-text strong {
          color: var(--text-primary);
      }

      /* Discrepancy Highlights */
      .discrepancies {
          margin-bottom: 1.5rem;
      }

      .discrepancy-item {
          padding: 0.75rem;
          background: #fef3c7;
          border-left: 3px solid #f59e0b;
          border-radius: 4px;
          margin-bottom: 0.5rem;
          font-size: 0.875rem;
      }

      .discrepancy-item.critical {
          background: #fee2e2;
          border-left-color: #ef4444;
      }

      /* Actions */
      .card-actions {
          display: flex;
          gap: 0.75rem;
          flex-wrap: wrap;
      }

      .btn {
          padding: 0.625rem 1.25rem;
          border: none;
          border-radius: 8px;
          font-size: 0.875rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
      }

      .btn-primary {
          background: var(--accent-blue);
          color: white;
      }

      .btn-primary:hover {
          background: #2563eb;
      }

      .btn-secondary {
          background: transparent;
          color: var(--accent-blue);
          border: 1px solid var(--accent-blue);
      }

      .btn-secondary:hover {
          background: var(--primary-navy-10);
      }

      .btn-danger {
          background: #ef4444;
          color: white;
      }

      .btn-danger:hover {
          background: #dc2626;
      }

      .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      /* Empty State */
      .empty-state {
          text-align: center;
          padding: 4rem 2rem;
          background: var(--surface-color);
          border-radius: 12px;
      }

      .empty-state-icon {
          font-size: 4rem;
          margin-bottom: 1rem;
          opacity: 0.5;
      }

      .empty-state h3 {
          font-size: 1.5rem;
          color: var(--text-primary);
          margin-bottom: 0.5rem;
      }

      .empty-state p {
          color: var(--text-secondary);
          margin-bottom: 2rem;
      }

      /* Loading Spinner */
      .spinner {
          display: inline-block;
          width: 1rem;
          height: 1rem;
          border: 2px solid var(--border-color);
          border-top-color: var(--accent-blue);
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          to { transform: rotate(360deg); }
      }

      /* Mobile */
      @media (max-width: 768px) {
          .analyses-grid {
              grid-template-columns: 1fr;
          }

          .results-grid {
              grid-template-columns: 1fr;
          }

          .dashboard-container {
              padding: 0 1rem;
          }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="dashboard-header">
        <div class="breadcrumb">
          <a href="/">Home</a> / <a href="/dashboard">Dashboard</a> / BWC
          Analysis
        </div>
        <h1>üé• BWC Analysis Dashboard</h1>
      </div>

      <!-- Analyses Grid -->
      <div class="analyses-grid" id="analysesGrid">
        <div class="empty-state">
          <div class="spinner"></div>
          <p>Loading analyses...</p>
        </div>
      </div>
    </div>

    <script>
      <div class="timeline-preview">
                                  <div class="timeline-header">
                                      <span class="timeline-title">Timeline Overview</span>
                                      <span class="timeline-duration">${formatDuration(analysis.duration)}</span>
                                  </div>
                                  <div class="timeline-bar">
                                      ${generateTimelineSegments(analysis)}
                                  </div>
                              </div>

                              ${generateQuickInsights(analysis)}

                              ${analysis.critical_discrepancies > 0 ? `
                                  <div class="discrepancies">
                                      <div class="discrepancy-item critical">
                                          ‚ö†Ô∏è ${analysis.critical_discrepancies} critical ${analysis.critical_discrepancies === 1 ? 'discrepancy' : 'discrepancies'} found - Review immediately
              async function loadAnalyses() {
                  try {
                      const response = await fetch('/api/analyses?per_page=100');
                      const data = await response.json();viewDetails('${analysis.id}')">
                                      üëÅÔ∏è View Full Analysis
                                  </button>
                                  <button class="btn-icon" onclick="exportReport('${analysis.id}', 'pdf')" title="Export PDF">
                                      üìÑ
                                  </button>
                                  <button class="btn-icon" onclick="exportReport('${analysis.id}', 'docx')" title="Export DOCX">
                                      üìù
                                  </button>
                                  <button class="btn-icon" onclick="exportReport('${analysis.id}', 'json')" title="Export JSON">
                                      üíæ
                                  </button>
                                  <button class="btn-icon btn-danger" onclick="deleteAnalysis('${analysis.id}')" title="Delete">
                                      üóëÔ∏è
                                  </button>
                              ` : isAnalyzing ? `
                                  <button class="btn btn-secondary" onclick="refreshStatus('${analysis.id}')">
                                      üîÑ Refresh Status
                                  </button>
                              ` : `
                                  <button class="btn btn-primary" onclick="startAnalysis('${analysis.id}')">
                                      ‚ñ∂Ô∏è Start Analysis
                                  </button>
                                  <button class="btn btn-danger" onclick="deleteAnalysis('${analysis.id}')">
                                      üóëÔ∏è Delete
                                  </button>
                              `}
                      `;
                      return;
                  }

                  grid.innerHTML = analyses.map(analysis => renderAnalysisCard(analysis)).join('');
              }

              function renderAnalysisCard(analysis) {
                  const isAnalyzing = analysis.status === 'analyzing';
                  const isCompleted = analysis.status === 'completed';
                  const isFailed = analysis.status === 'failed';

                  return `
                      <div class="analysis-card ${analysis.status}" data-id="${analysis.id}">
                          <div class="card-header">
                              <div class="card-title">
                                  <h3>${escapeHtml(analysis.filename)}</h3>
                                  <div class="card-meta">
                                      ${analysis.case_number ? `Case #${escapeHtml(analysis.case_number)}` : 'No case number'}
                                       ‚Ä¢ ${formatDate(analysis.created_at)}
                                  </div>
                              </div>
                              <div class="status-badge ${analysis.status}">
                                  ${isAnalyzing ? '<span class="spinner"></span> ' : ''}
                                  ${analysis.status}
                              </div>
                          </div>

                          ${isAnalyzing ? `
                              <div class="progress-section">
                                  <div class="progress-header">
                                      <span class="progress-label">Processing...</span>
                                      <span class="progress-percent">${analysis.progress}%</span>
                                  </div>
                                  <div class="progress-bar">
                                      <div class="progress-fill" style="width: ${analysis.progress}%"></div>
                                  </div>
                                  ${analysis.current_step ? `
                                      <div class="current-step">${escapeHtml(analysis.current_step)}</div>
                                  ` : ''}
                              </div>
                          ` : ''}

                          ${isCompleted ? `
                              <div class="results-grid">
                                  <div class="result-item">
                                      <div class="result-value">${analysis.total_speakers || 0}</div>
                                      <div class="result-label">Speakers</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-value">${analysis.total_segments || 0}</div>
                                      <div class="result-label">Segments</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-value">${analysis.total_discrepancies || 0}</div>
                                      <div class="result-label">Discrepancies</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-value">${analysis.critical_discrepancies || 0}</div>
                                      <div class="result-label">Critical</div>
                                  </div>
                              </div>

                              ${analysis.critical_discrepancies > 0 ? `
                                  <div class="discrepancies">
                                      <div class="discrepancy-item critical">
                                          ‚ö†Ô∏è ${analysis.critical_discrepancies} critical discrepancy found
                                      </div>
                                  </div>
                              ` : ''}
                          ` : ''}

                          ${isFailed ? `
                              <div class="discrepancies">
                       generateTimelineSegments(analysis) {
                  if (!analysis.duration || analysis.duration === 0) return '';

                  const speakers = analysis.total_speakers || 1;
                  const segments = [];

                  // Generate mock segments for visualization
                  for (let i = 0; i < speakers; i++) {
                      const start = (i / speakers) * 100;
                      const width = (1 / speakers) * 100;
                      segments.push(`
                          <div class="timeline-segment speaker-${i % 3}"
                               style="left: ${start}%; width: ${width}%"
                               title="Speaker ${i + 1}">
                          </div>
                      `);
                  }

                  return segments.join('');
              }

              function generateQuickInsights(analysis) {
                  const insights = [];

                  if (analysis.duration) {
                      const minutes = Math.floor(analysis.duration / 60);
                      const seconds = Math.floor(analysis.duration % 60);
                      insights.push({
                          icon: '‚è±Ô∏è',
                          text: `Total duration: <strong>${minutes}m ${seconds}s</strong>`
                      });
                  }

                  if (analysis.total_speakers && analysis.total_speakers > 0) {
                      insights.push({
                          icon: 'üë•',
                          text: `<strong>${analysis.total_speakers}</strong> distinct ${analysis.total_speakers === 1 ? 'speaker' : 'speakers'} identified`
                      });
                  }

                  if (analysis.total_segments && analysis.total_segments > 0) {
                      insights.push({
                          icon: 'üí¨',
                          text: `<strong>${analysis.total_segments}</strong> transcript segments processed`
                      });
                  }

                  if (analysis.total_discrepancies === 0) {
                      insights.push({
                          icon: '‚úÖ',
                          text: 'No discrepancies detected - Clean analysis'
                      });
                  } else if (analysis.critical_discrepancies > 0) {
                      insights.push({
                          icon: '‚ö†Ô∏è',
                          text: `<strong>${analysis.critical_discrepancies}</strong> critical ${analysis.critical_discrepancies === 1 ? 'issue' : 'issues'} require immediate attention`
                      });
                  }

                  if (insights.length === 0) return '';

                  return `
                      <div class="quick-insights">
                          ${insights.map(insight => `
                              <div class="insight-item">
                                  <span class="insight-icon">${insight.icon}</span>
                                  <div class="insight-text">${insight.text}</div>
                              </div>
                          `).join('')}
                      </div>
                  `;
              }

              function formatDuration(seconds) {
                  if (!seconds) return '0:00';
                  const mins = Math.floor(seconds / 60);
                  const secs = Math.floor(seconds % 60);
                  return `${mins}:${secs.toString().padStart(2, '0')}`;
              }

              async function viewDetails(analysisId) {
                  const analysis = analyses.find(a => a.id === analysisId);
                  if (!analysis) return;

                  // Load full analysis data
                  try {
                      const response = await fetch(`/api/analysis/${analysisId}`);
                      const fullData = await response.json();

                      const modal = document.getElementById('detailModal');
                      const modalTitle = document.getElementById('modalTitle');
                      const modalBody = document.getElementById('modalBody');

                      modalTitle.textContent = fullData.filename;

                      modalBody.innerHTML = `
                          <div class="detail-section">
                              <h3>üìã Case Information</h3>
                              <div class="results-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                  <div class="result-item">
                                      <div class="result-label">Case Number</div>
                                      <div style="font-weight: 600; margin-top: 0.5rem;">${fullData.case_number || 'N/A'}</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-label">Evidence Number</div>
                                      <div style="font-weight: 600; margin-top: 0.5rem;">${fullData.evidence_number || 'N/A'}</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-label">File Hash</div>
                                      <div style="font-weight: 600; margin-top: 0.5rem; font-family: monospace; font-size: 0.75rem;">${fullData.file_hash.substring(0, 16)}...</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-label">File Size</div>
                                      <div style="font-weight: 600; margin-top: 0.5rem;">${formatFileSize(fullData.file_size)}</div>
                                  </div>
                              </div>
                          </div>

                          <div class="detail-section">
                              <h3>üìä Analysis Results</h3>
                              <div class="results-grid" style="grid-template-columns: repeat(4, 1fr);">
                                  <div class="result-item">
                                      <div class="result-value">${fullData.total_speakers || 0}</div>
                                      <div class="result-label">Speakers Identified</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-value">${fullData.total_segments || 0}</div>
                                      <div class="result-label">Transcript Segments</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-value">${fullData.total_discrepancies || 0}</div>
                                      <div class="result-label">Total Discrepancies</div>
                                  </div>
                                  <div class="result-item">
                                      <div class="result-value" style="color: #ef4444;">${fullData.critical_discrepancies || 0}</div>
                                      <div class="result-label">Critical Issues</div>
                                  </div>
                              </div>
                          </div>

                          <div class="detail-section">
                              <h3>üîó Chain of Custody</h3>
                              <div style="background: var(--bg-color); padding: 1.5rem; border-radius: 8px;">
                                  <p style="margin-bottom: 0.5rem;"><strong>SHA-256 Hash:</strong> <code style="font-size: 0.875rem; background: var(--surface-color); padding: 0.25rem 0.5rem; border-radius: 4px;">${fullData.file_hash}</code></p>
                                  <p style="margin-bottom: 0.5rem;"><strong>Acquired By:</strong> ${fullData.acquired_by || 'Not specified'}</p>
                                  <p style="margin-bottom: 0.5rem;"><strong>Source:</strong> ${fullData.source || 'Not specified'}</p>
                                  <p style="margin-bottom: 0;"><strong>Analysis Date:</strong> ${new Date(fullData.created_at).toLocaleString()}</p>
                              </div>
                          </div>

                          <div class="detail-section">
                              <h3>üì• Export Options</h3>
                              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                  <button class="btn btn-primary" onclick="exportReport('${analysisId}', 'pdf')">üìÑ Export PDF Report</button>
                                  <button class="btn btn-secondary" onclick="exportReport('${analysisId}', 'docx')">üìù Export DOCX</button>
                                  <button class="btn btn-secondary" onclick="exportReport('${analysisId}', 'json')">üíæ Export JSON Data</button>
                                  <button class="btn btn-secondary" onclick="exportReport('${analysisId}', 'txt')">üìã Export Text Transcript</button>
                                  <button class="btn btn-secondary" onclick="exportReport('${analysisId}', 'md')">üìÑ Export Markdown</button>
                              </div>
                          </div>
                      `;

                      modal.classList.add('active');
                  } catch (error) {
                      console.error('Error loading details:', error);
                      alert('Failed to load analysis details');
                  }
              }

              function closeModal() {
                  const modal = document.getElementById('detailModal');
                  modal.classList.remove('active');
              }

              // Close modal on outside click
              document.getElementById('detailModal')?.addEventListener('click', (e) => {
                  if (e.target.id === 'detailModal') {
                      closeModal();
                  }
              });

              function formatFileSize(bytes) {
                  if (!bytes) return '0 B';
                  const k = 1024;
                  const sizes = ['B', 'KB', 'MB', 'GB'];
                  const i = Math.floor(Math.log(bytes) / Math.log(k));
                  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]error_message ? `: ${escapeHtml(analysis.error_message)}` : ''}
                                  </div>
                              </div>
                          ` : ''}

                          <div class="card-actions">
                              ${isCompleted ? `
                                  <button class="btn btn-primary" onclick="exportReport('${analysis.id}', 'pdf')">
                                      üìÑ Export PDF
                                  </button>
                                  <button class="btn btn-secondary" onclick="exportReport('${analysis.id}', 'docx')">
                                      üìù Export DOCX
                                  </button>
                                  <button class="btn btn-secondary" onclick="viewDetails('${analysis.id}')">
                                      üëÅÔ∏è View Details
                                  </button>
                              ` : isAnalyzing ? `
                                  <button class="btn btn-secondary" onclick="refreshStatus('${analysis.id}')">
                                      üîÑ Refresh
                                  </button>
                              ` : `
                                  <button class="btn btn-primary" onclick="startAnalysis('${analysis.id}')">
                                      ‚ñ∂Ô∏è Start Analysis
                                  </button>
                              `}
                              <button class="btn btn-danger" onclick="deleteAnalysis('${analysis.id}')">
                                  üóëÔ∏è Delete
                              </button>
                          </div>
                      </div>
                  `;
              }

              async function refreshStatus(analysisId) {
                  try {
                      const response = await fetch(`/api/analysis/${analysisId}/status`);
                      const data = await response.json();

                      // Update the analysis in our array
                      const index = analyses.findIndex(a => a.id === analysisId);
                      if (index !== -1) {
                          analyses[index] = { ...analyses[index], ...data };
                          renderAnalyses();
                      }
                  } catch (error) {
                      console.error('Error refreshing status:', error);
                  }
              }

              function startRealTimeUpdates() {
                  // Clear existing interval
                  if (updateInterval) {
                      clearInterval(updateInterval);
                  }

                  // Update every 2 seconds for analyzing videos
                  updateInterval = setInterval(async () => {
                      const analyzingVideos = analyses.filter(a => a.status === 'analyzing');

                      if (analyzingVideos.length === 0) {
                          return;
                      }

                      for (const analysis of analyzingVideos) {
                          await refreshStatus(analysis.id);
                      }
                  }, 2000);
              }

              async function exportReport(analysisId, format) {
                  try {
                      window.location.href = `/api/analysis/${analysisId}/report/${format}`;
                  } catch (error) {
                      alert('Error exporting report: ' + error.message);
                  }
              }

              function viewDetails(analysisId) {
                  window.location.href = `/analysis/${analysisId}`;
              }

              async function deleteAnalysis(analysisId) {
                  if (!confirm('Are you sure you want to delete this analysis?')) return;

                  try {
                      const response = await fetch(`/api/analysis/${analysisId}`, {
                          method: 'DELETE'
                      });

                      if (response.ok) {
                          analyses = analyses.filter(a => a.id !== analysisId);
                          renderAnalyses();
                      } else {
                          throw new Error('Failed to delete analysis');
                      }
                  } catch (error) {
                      alert('Error deleting analysis: ' + error.message);
                  }
              }

              function formatDate(dateString) {
                  const date = new Date(dateString);
                  const now = new Date();
                  const diff = now - date;
                  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

                  if (days === 0) return 'Today';
                  if (days === 1) return 'Yesterday';
                  if (days < 7) return `${days} days ago`;

                  return date.toLocaleDateString();
              }

              function escapeHtml(text) {
                  const div = document.createElement('div');
                  div.textContent = text;
                  return div.innerHTML;
              }

              function showError(message) {
                  const grid = document.getElementById('analysesGrid');
                  grid.innerHTML = `
                      <div class="empty-state">
                          <div class="empty-state-icon">‚ö†Ô∏è</div>
                          <h3>Error</h3>
                          <p>${escapeHtml(message)}</p>
                          <button class="btn btn-primary" onclick="loadAnalyses()">Retry</button>
                      </div>
                  `;
              }

              // Initialize
              loadAnalyses();

              // Cleanup on page unload
              window.addEventListener('beforeunload', () => {
                  if (updateInterval) {
                      clearInterval(updateInterval);
                  }
              });
    </script>
  </body>
</html>
