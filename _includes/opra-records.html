{%- comment -%}
Unified OPRA records include
Usage examples:
  {% include opra-records.html case="atl-l-003252-25" %}
  {% include opra-records.html topic="toll-enforcement" %}
  {% include opra-records.html status="Active" %}
  {% include opra-records.html authorities="Atlantic County Sheriff's Office|ACIA" %}
  {% include opra-records.html mode="quick" %}  # for compact/quick-links style
  {% include opra-records.html mode="list" %}   # for full list style (default)
{%- endcomment -%}

{%- assign want_status = include.status | default: "ALL" -%}
{%- assign authorities = include.authorities | default: "" -%}
{%- assign auth_list = authorities | split: "|" -%}
{%- assign want_case = include.case | default: page.case_slug | default: "" -%}
{%- assign want_topic = include.topic | default: "" -%}
{%- assign mode = include.mode | default: "list" -%}

{%- assign opra_items = site.data.opra -%}
{%- assign opra_case_map = site.data.opra_case_map -%}
{%- if opra_items == nil or opra_items.size == 0 -%}
  {%- assign opra_items = site.opra -%}
{%- endif -%}

{%- assign filtered = opra_items | sort: "opened" | reverse -%}
{%- assign results = "" | split: "" -%}

{%- for r in filtered -%}
  {%- assign rid = r.id | default: r.slug -%}
  {%- assign ok_status = true -%}
  {%- assign ok_auth = true -%}
  {%- assign ok_case = true -%}
  {%- assign ok_topic = true -%}

  {%- if want_status != "ALL" and r.status != want_status -%}
    {%- assign ok_status = false -%}
  {%- endif -%}

  {%- if authorities != "" -%}
    {%- assign ok_auth = false -%}
    {%- for a in auth_list -%}
      {%- assign a_trim = a | strip -%}
      {%- if r.authority_primary and (r.authority_primary contains a_trim or r.authority_primary == a_trim) -%}
        {%- assign ok_auth = true -%}
      {%- endif -%}
      {%- if r.authority_parallel -%}
        {%- for ap in r.authority_parallel -%}
          {%- if ap contains a_trim or ap == a_trim -%}
            {%- assign ok_auth = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- if want_case != "" -%}
    {%- assign ok_case = false -%}
    {%- if opra_case_map and opra_case_map[want_case] -%}
      {%- assign mapped = opra_case_map[want_case] -%}
      {%- if mapped contains rid -%}
        {%- assign ok_case = true -%}
      {%- endif -%}
    {%- elsif r.related_cases and r.related_cases contains want_case -%}
      {%- assign ok_case = true -%}
    {%- endif -%}
  {%- endif -%}

  {%- if want_topic != "" -%}
    {%- assign ok_topic = false -%}
    {%- if r.topics -%}
      {%- assign topics_str = r.topics | join: "|" | downcase -%}
      {%- if topics_str contains want_topic -%}
        {%- assign ok_topic = true -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}

  {%- if ok_status and ok_auth and ok_case and ok_topic -%}
    {%- assign results = results | push: r -%}
  {%- endif -%}
{%- endfor -%}


{%- if results.size > 0 -%}
  <section class="opra-records u-mb-md u-py-xs" aria-label="Related OPRA Records">
    {%- if include.heading != false -%}
      <h3 class="opra-records__heading u-text-xs u-text-muted u-mb-xs" style="font-weight: 500; letter-spacing: 0.01em;">Related OPRA Administrative Records</h3>
    {%- endif -%}
    <ul class="opra-records__list u-list-unstyled u-m-0 u-p-0 {%- if mode == 'quick' -%} opra-records__list--quick{%- endif -%}">
      {%- for r in results -%}
        {%- assign internal_url = r.url -%}
        {%- if internal_url == nil and r.permalink -%}
          {%- assign internal_url = r.permalink -%}
        {%- endif -%}
        {%- assign ext_url = r.opramachine_request_url -%}
        {%- if ext_url == nil or ext_url == "" -%}
          {%- assign ext_url = r.opramachine_body_url -%}
        {%- endif -%}
        {%- if ext_url == nil or ext_url == "" -%}
          {%- assign ext_url = r.opramachine_url -%}
        {%- endif -%}
        <li class="opra-records__item u-mb-xs u-p-xs u-radius-sm u-bg-faint">
          <div class="opra-records__title u-flex u-align-center u-gap-xs">
            {%- if internal_url -%}
              <a href="{{ internal_url | relative_url }}" class="u-text-accent u-text-bold"><span>{{ r.title | escape }}</span></a>
            {%- else -%}
              <span class="u-text-bold">{{ r.title | escape }}</span>
            {%- endif -%}
            {%- if ext_url -%}
              <a class="opra-records__ext u-text-xs u-text-muted u-ml-xs" href="{{ ext_url | escape }}" target="_blank" rel="noopener" title="View on OPRAMachine">â†—</a>
            {%- endif -%}
          </div>
          <div class="opra-records__meta u-flex u-gap-xs u-text-xs u-text-muted u-mt-2xs">
            {%- if r.status -%}
              <span class="badge badge-status u-bg-muted u-radius-xs u-px-2xs">{{ r.status | escape }}</span>
            {%- endif -%}
            {%- if r.opened -%}
              <span class="meta">Opened: {{ r.opened }}</span>
            {%- endif -%}
            {%- if r.authority_primary -%}
              <span class="meta">Custodian: {{ r.authority_primary | escape }}</span>
            {%- endif -%}
          </div>
        </li>
      {%- endfor -%}
    </ul>
  </section>
{%- endif -%}
