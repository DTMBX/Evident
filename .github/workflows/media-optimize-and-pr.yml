name: Media Optimize and PR

on:
  push:
    paths:
      - 'src/assets/media/**'
      - 'src/assets/images/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  optimize-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create renditions dir
        run: mkdir -p src/assets/media/renditions

      - name: Transcode MP4 renditions
        run: |
          if [ -f src/assets/media/flag.mp4 ]; then
            ffmpeg -y -i src/assets/media/flag.mp4 -c:v libx264 -preset medium -crf 23 -c:a aac -b:a 128k -vf scale=-2:360 src/assets/media/renditions/flag-360p.mp4
            ffmpeg -y -i src/assets/media/flag.mp4 -c:v libx264 -preset medium -crf 23 -c:a aac -b:a 128k -vf scale=-2:720 src/assets/media/renditions/flag-720p.mp4
            ffmpeg -y -i src/assets/media/flag.mp4 -c:v libx264 -preset medium -crf 23 -c:a aac -b:a 128k -vf scale=-2:1080 src/assets/media/renditions/flag-1080p.mp4
          else
            echo "No src/assets/media/flag.mp4 found; skipping transcode"
          fi

      - name: Transcode WebM renditions
        run: |
          if [ -f src/assets/media/flag.mp4 ]; then
            ffmpeg -y -i src/assets/media/flag.mp4 -c:v libvpx-vp9 -b:v 0 -crf 33 -vf scale=-2:360 -an src/assets/media/renditions/flag-360p.webm
            ffmpeg -y -i src/assets/media/flag.mp4 -c:v libvpx-vp9 -b:v 0 -crf 33 -vf scale=-2:720 -an src/assets/media/renditions/flag-720p.webm
            ffmpeg -y -i src/assets/media/flag.mp4 -c:v libvpx-vp9 -b:v 0 -crf 33 -vf scale=-2:1080 -an src/assets/media/renditions/flag-1080p.webm
          else
            echo "No src/assets/media/flag.mp4 found; skipping webm transcode"
          fi

      - name: Optimize poster with sharp
        run: |
          node ./scripts/convert-poster.js || echo "Poster optimization skipped or failed"

      - name: Check for optimized outputs
        id: check
        run: |
          if ls src/assets/media/renditions/* >/dev/null 2>&1 || test -f src/assets/images/flag-poster.webp; then echo "found=true" > result.txt; else echo "found=false" > result.txt; fi
          cat result.txt

      - name: Create branch and commit optimized files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          SHA=$(git rev-parse --short HEAD)
          BRANCH=media/optimized-${SHA}
          git checkout -b ${BRANCH}
          git add -A src/assets/media/renditions src/assets/images/flag-poster.webp src/assets/images/flag-poster.jpg || true
          if git diff --cached --quiet; then
            echo "No optimized files to commit"
          else
            git commit -m "chore(media): add optimized renditions and poster (automated)"
            git push --set-upstream origin ${BRANCH}
            echo "pushed_branch=${BRANCH}" >> $GITHUB_ENV
          fi

      - name: Open PR with optimized media
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = process.env.pushed_branch || `media/optimized-${process.env.GITHUB_SHA.substring(0,7)}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            try {
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                head: branch,
                base: 'chore/repo-layout',
                title: 'Automated: optimized media renditions',
                body: 'This PR adds optimized video renditions and poster images generated by CI. Review and merge if acceptable.'
              });
              console.log('PR created: ' + pr.data.html_url);
            } catch (e) {
              console.log('PR creation skipped or failed: ' + e.message);
            }
